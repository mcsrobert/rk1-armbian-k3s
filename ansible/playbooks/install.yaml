---
- name: Prepare k3s install
  hosts: k3s_cluster
  become: true

  handlers:

    - name: Restart SSH
      ansible.builtin.service:
        name: sshd
        state: restarted

    - name: Update initramfs
      ansible.builtin.command: update-initramfs -u

  tasks:

    - name: Verify we are booted from NVMe
      ansible.builtin.shell: findmnt -n -o SOURCE /
      register: root_drive
      failed_when: "'nvme' not in root_drive.stdout"
      changed_when: false
      when: inventory_hostname != 'raspberrypi'

    - name: Set system hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      register: hostname_changed

    - name: Update /etc/hosts entry
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1'
        line: "127.0.1.1 {{ inventory_hostname }}"
      when: hostname_changed.changed

    - name: Install dependencies for k3s and Longhorn
      ansible.builtin.apt:
        name:
          - open-iscsi
          - nfs-common
        state: present
        update_cache: yes

    - name: Enable and start iscsid service
      ansible.builtin.service:
        name: iscsid
        state: started
        enabled: yes

    - name: Load dm_crypt module
      community.general.modprobe:
        name: dm_crypt
        state: present

    - name: Ensure dm_crypt persists on reboot
      ansible.builtin.copy:
        content: "dm_crypt\n"
        dest: /etc/modules-load.d/dm_crypt.conf
        owner: root
        group: root
        mode: '0644'
      notify: Update initramfs

    - name: Check if multipathd is running and disable it
      block:

        - name: Check if multipathd service exists
          ansible.builtin.command: systemctl list-unit-files multipathd.service
          register: multipathd_check
          changed_when: false
          failed_when: false

        - name: Disable and mask multipathd for Longhorn
          ansible.builtin.systemd:
            name: multipathd
            state: stopped
            enabled: no
            masked: yes
          when: "'multipathd.service' in multipathd_check.stdout"

    - name: Harden SSH Configuration
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        validate: 'sshd -t -f %s'
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?ChallengeResponseAuthentication', line: 'ChallengeResponseAuthentication no' }
        - { regexp: '^#?KbdInteractiveAuthentication', line: 'KbdInteractiveAuthentication no' }
        - { regexp: '^#?PermitEmptyPasswords', line: 'PermitEmptyPasswords no' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
      notify: Restart SSH

    - name: Sync Ghostty terminfo
      block:

        - name: Get local Ghostty terminfo
          ansible.builtin.command: infocmp -x xterm-ghostty
          delegate_to: localhost
          register: local_terminfo
          become: false
          run_once: true
          changed_when: false

        - name: Apply terminfo to remote server
          ansible.builtin.shell: tic -x -
          args:
            stdin: "{{ local_terminfo.stdout }}"

- name: Install RK3588 drivers
  import_playbook: ./rk3588_drivers.yaml

- name: Configure kube-vip
  import_playbook: ./kube-vip.yaml

- name: Install k3s
  import_playbook: k3s.orchestration.site
